{% extends "question/base_question.html" %}
{% load custom_tags %}
{% load custom_filters %}
{% block title %}{{question.title|str_display:20}}{% endblock %}

{% block javascript %}
<script type="text/javascript">
$(document).ready(function(){

  // 导航事件
  /*
  $('.replies .nav-tabs a').click(function (e) {
    e.preventDefault();
    $(this).tab('show');

    $('#ul_replies').hide('fast').show('fast');
  });
  */

  // 
  $('.not-login .btn-login').bind('click', function(){
    window.location.href = '/login';
  });
  $('.not-login .btn-regist').bind('click', function(){
    window.location.href = '/regist';
  });

  // 删除回复事件
  $('.reply-main').bind('mouseover', function(){
    
    $(this).find('.remove-reply').removeClass('hide');
  })
  .bind('mouseout', function(){

    $(this).find('.remove-reply').addClass('hide');
  });
  
  
  // 赞动作
  var voteLoading = false;
  $('.vote button').bind('click', function(){
    if(voteLoading){
      return;
    }
    voteLoading = true;

    var btn = $(this),
        likedSpan = btn.children('span').eq(0),
        votedSpan = btn.children('span').eq(1),
        isLiked = likedSpan.hasClass('glyphicon-heart'),
        voteCount = parseInt(votedSpan.text());
        
    // 取消赞动作
    if(isLiked){
      // 动画效果
      likedSpan.css('opacity', '0.99').animate({
        opacity: 0.1,
      }, 500, function(){

        likedSpan.removeClass('glyphicon-heart').addClass('glyphicon-heart-empty').css('opacity', '0.99');
        votedSpan.text(voteCount - 1);
        voteLoading = false;
      });

    
    } else {
      // 添加赞动作
      btn.parent('.btn-group-vertical').append('<span class="glyphicon glyphicon-heart animate-liked"></span>');
      
      // 动画效果
      var animateLike = btn.siblings();
      animateLike.animate({
        opacity: 0.01,
        fontSize: 16,
        paddingLeft: 10,
        paddingTop: 6
      }, 500, function(){
        animateLike.remove();

        likedSpan.removeClass('glyphicon-heart-empty').addClass('glyphicon-heart');
        votedSpan.text(voteCount + 1);
        voteLoading = false;
      });

    }

  });


  // 精华盖章动画
  var jinghua = $('.jinghua img');
  jinghua.show()
  .css({'width': '444.5px', 'height': '385px'})
  .animate({'width': '254', 'height': '220px', 'opacity': '0.6'}, 500)
  .animate({'width': '127px', 'height': '110px', 'opacity': '0.99'}, 50);

});
</script>
{% endblock %}

{% block css %}
<style type="text/css">

.zx-container-main .question-entry{
    float: left;
    /*padding-top: 25px;*/
    width: 100%;
}

.zx-container-main .question-entry .topic{
    border-radius: 4px;
    padding: 15px;
    border: solid 1px #ddd;
}

.zx-container-main .question-entry .topic-title{

}

.zx-container-main .question-entry .topic-content{
    padding-top: 25px;
    font-size: 13px;
    color: #475058;
}

.zx-container-main .question-entry .topic-footer{
    padding-top: 25px;
}

.zx-container-main .question-entry .question-date{
    float: right;
    font-size: 12px;
    color: #475058;
}

.zx-container-main .replies{
    float: left;
    width: 100%;
    padding-top: 25px;
}

.zx-container-main .reply-header{
    padding: 15px 5px 5px 5px;
}


.zx-container-main .reply-header .user-name a{
    color: #224e73;
    font-size: 12px;
}

.zx-container-main .reply-content{
    font-size: 13px;
    color: #475058;
    padding-top: 15px;
    padding-bottom: 25px;
    line-height: 25px;
}

.zx-container-main .reply-main .vote{
    padding-left: 30px;
}

.zx-container-main .reply-main .vote .btn-group-vertical{
    width: 90%;
}


.answer-title{
  border-bottom: solid 1px #e6e6e6;
}

.answer-main{
  margin-top: 15px;
  border: solid 1px #e6e6e6;
  border-radius: 5px;
}

.answer-main .editor{
  margin-bottom: 0px;
}

.answer-main button{
  margin-top: 15px;
}

.not-login{
  font-size: 12px;
}

.not-login .title{
  font-size: 12px;
  padding: 25px 0 15px 0;
}

.not-login .content{
  font-size: 12px;
  padding-bottom: 15px;
  line-height: 22px;
}

.not-login .links{
  margin-bottom: 20px;
}

.not-login .lock{
  padding: 15px 0 0 30px;
}

.vote .glyphicon{
  font-size: 16px;
}

.vote .glyphicon-heart{
  color: red;
}

.vote .animate-liked{
  position: absolute;
  top: 0px;
  left: 2px;
  z-index: 99;
  font-size: 35px;
  opacity: 0.99,
}

.breadcrumb{
  margin-top: 25px;
  border: solid 1px #ddd;
}

.replies-sort{
  margin-top: 5px;
}

.my-reply{
  background-color: #f1f1f1;
}

.question-tool{
    font-size: 12px;
    float: right;
    padding-right: 10px;
}

.remove-reply{
    font-size: 12px;
    padding-top: 15px;
    width: 90%;
    text-align: center;
}

.question-content{
    border: solid 1px #ddd;
    border-radius: 4px;
}

.jinghua img{
  width: 127px;
  height: 110px;
  position: absolute;
  right: 40px;
  display: none;
  opacity: 0.1;
  top: 100px;
  z-index: 99;
}
</style>
{% endblock %}

{% block question_main%}
<span class="jinghua"><img src="{{MEDIA_URL}}img/common/jinghua1.png"></span>

<ol class="breadcrumb">
    <li>
        <a href="/question">全部</a>
    </li>
    <li>
        <a href="{{question.question_type.get_url}}">{{question.question_type.name}}</a>
    </li>
    <li class="active">{{question.title|str_display:10}}</li>
</ol>
<div class="question-entry">
    <div class="topic">
        
        <div class="topic-title">
            <h4> <strong>{{question.title}}</strong>
            </h4>
        </div>
        <div class="topic-content">{{question.content|safe}}</div>
        <div class="topic-footer">
            {% if not question.is_hide_user %}
            <a href="{{question.user.get_url}}">
                <div class="avatar">
                    <img src="{{question.user.get_avatar}}" title="{{question.user.nick}}" />
                </div>
            </a>
            <a href="{{question.user.get_url}}">
                <div class="user-name">{{question.user.nick}}</div>
            </a>
            {% endif %}
            <div class="question-date">{{question.create_time}}</div>
            {% if request.user.id == question.user.id %}
            <div class="question-tool"><a href="#" data-toggle="modal" data-target="#edit_modal"><span class="glyphicon glyphicon-pencil"></span>修改提问</a></div>

            <!-- 弹出层 -->
            <div class="modal fade" id="edit_modal">
              <div class="modal-dialog">
                <div class="modal-content">
                    <form role="form" method='post' action='/question/modify_question'>
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">修改提问</h4>
                      </div>
                      <div class="modal-body">
                    
                        <div class="form-group">
                            <select name="question_type" class="form-control">
                                <option value='0'>请选择问题类型</option>
                                {% question_type_option_display %}
                            </select>
                        </div>
                        <div class="blank10"></div>
                        <div class="form-group">
                            <input type="text" class="form-control" name="question_title" placeholder="你有什么想问的？写下问题的标题" 
                                    value='{{question.title}}'></div>
                        <div class="form-group question-content">
                            <textarea name="question_content" class="form-control zx-textarea auto-height-textarea" rows="10">{{question.content}}</textarea>
                        </div>
                    
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                      </div>
                  </form>
                </div><!-- /.modal-content -->
              </div><!-- /.modal-dialog -->
            </div><!-- /.modal -->
            <!-- 弹出层结束 -->
            {% endif %}
        </div>
    </div>

    <div class="replies">
        <ul class="list-group" id="ul_replies">
            <li class="list-group-item">
                <div class="row">
                    <div class="col-md-6">
                        <h4> <strong>共{{question.answer_count}}个回答</strong>
                        </h4>
                    </div>
                    <div class="col-md-3 pull-right">
                        <select class="form-control input-sm replies-sort">
                            <option>按赞最多排序</option>
                            <option>按时间排序</option>
                        </select>
                    </div>
                </div>
            </li>

            {% for answer in answers %}
            <li class="list-group-item {% if answer.from_user_id == question.user_id %}my-reply{% endif %}">
                <div class="reply-header">
                    <a href="{{answer.from_user.get_url}}">
                        <div class="avatar">
                            <img src="{{answer.from_user.get_avatar}}" title="{{answer.from_user.nick}}" />
                        </div>
                    </a>
                    <a href="{{answer.from_user.get_url}}">
                        <div class="user-name">{{answer.from_user.nick}}</div>
                    </a>
                    <div class="question-date">{{answer.create_time|time_format}}</div>
                </div>
                <div class="reply-main row">
                    <div class="reply-content col-md-9">{{answer.content|safe}}</div>
                    <div class="vote col-md-3">
                        <div class="btn-group-vertical">
                            <button type="button" class="btn btn-default">
                                <span class="glyphicon glyphicon-heart pull-left"></span>
                                <span class="badge">{{answer.zan_num}}</span>
                            </button>
                        </div>
                        {% if question.user.id == request.user.id %}
                        <div class="remove-reply hide"><a href="#"><span class="glyphicon glyphicon-remove"></span>删除回答</a></div>
                        {% endif %}
                    </div>
                </div>
            </li>
            {% endfor %}

            <li class="list-group-item">
                <div class="reply-header">
                    <a href="#">
                        <div class="avatar">
                            <img src="{{MEDIA_URL}}img/common/default.png" />
                        </div>
                    </a>
                    <a href="#">
                        <div class="user-name">有利网小利</div>
                    </a>
                    <div class="question-date">2013.12.15 15:23:12</div>
                </div>
                <div class="reply-main row">
                    <div class="reply-content col-md-9">各有优缺点。有利在安全上还是比较靠谱，只是利率低一点。陆金所还可以，毕竟是平安集团旗下的，但开鑫贷我不看好。</div>
                    <div class="vote col-md-3">
                        <div class="btn-group-vertical">
                            <button type="button" class="btn btn-default">
                                <span class="glyphicon glyphicon-heart-empty pull-left"></span>
                                <span class="badge">12</span>
                            </button>
                        </div>
                        <div class="remove-reply hide"><a href="#"><span class="glyphicon glyphicon-remove"></span>删除回答</a></div>
                    </div>
                </div>
            </li>
        </ul>
    </div>

    <!-- 回复块 -->
    <div class="answer">
        <div class="answer-title">
            <h3>你可以在下面添加你的回答</h3>
        </div>

        <div class="answer-main">
            {% if request.user.is_authenticated %}
            <form role="form" method="post" action="/question/create_answer/{{question.id}}">
                <div class="form-group editor">
                    <textarea name="answer_content" class="form-control zx-textarea auto-height-textarea" rows="10">{{content}}</textarea>
                </div>
                <div class="form-group pull-right">
                    <button type="submit" class="btn btn-primary">提交你的回答</button>
                </div>
            </form>
            {% else %}
            <div class="not-login row">
                <div class="col-md-2 lock">
                    <img src="{{MEDIA_URL}}img/common/icon-locked.png"></div>
                <div class="col-md-10">
                    <div class="title">回复前请登录</div>
                    <div class="content">须登录后才能发表你的回复，点击下面的登录按钮进行登录，如果你还没有成为我们的会员，请点击下面的注册按钮进行新用户注册</div>
                    <div class="col-md-6 links">
                        <a href="/login">
                            <button type="button" class="btn btn-primary btn-lg btn-login">立即登录</button>
                        </a>
                    </div>
                    <div class="col-md-6 links">
                        <a href="/regist">
                            <button type="button" class="btn btn-primary btn-lg btn-regist">免费注册</button>
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}