{% extends "question/base_question.html" %}
{% load custom_tags %}
{% load custom_filters %}
{% block title %}{{question.title|str_display:20}}{% endblock %}

{% block javascript %}
<script type="text/javascript" src="{{MEDIA_URL}}js/question.js"></script>
<script type="text/javascript">
    $(document).ready(function(){

        // 导航事件
        /*
        $('.replies .nav-tabs a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');

        $('#ul_replies').hide('fast').show('fast');
        });
        */

        // 按钮点击事件 IE直接点还不行,非要js
        $('.not-login .btn-login').bind('click', function(){
            window.location.href = '/login';
        });
        $('.not-login .btn-regist').bind('click', function(){
            window.location.href = '/regist';
        });

        // 回答工具条显示隐藏事件
        $('#ul_replies .list-group-item')
        .bind('mouseenter', function(){
          $(this).find('.reply-tools .autohide').show();
        })
        .bind('mouseleave', function(){
          $(this).find('.reply-tools .autohide').hide();
        });
        // 评论工具条显示隐藏事件
        $('.reply-comments .comment')
        .bind('mouseenter', function(){
          $(this).find('.comment-date .autohide').show();
        })
        .bind('mouseleave', function(){
          $(this).find('.comment-date .autohide').hide();
        });
        // 隐藏所有 autohide 样式
        $('.autohide').hide();
      
        // 评论打开关闭事件
        $('.reply-tools .comments').bind('click', function(){
          var target = $(this).parent().next();
          
          if(target.css('display') === 'block'){
            target.hide('fast');
          } else {
            target.show('fast');
          }
        })
      
        // 赞动作
        var voteLoading = false;
        $('.vote button').bind('click', function(){
            if(voteLoading){
                return;
            }
            voteLoading = true;

            var btn = $(this),
                likedSpan = btn.children('span').eq(0),
                votedSpan = btn.children('span').eq(1),
                isLiked = likedSpan.hasClass('glyphicon-heart'),
                voteCount = parseInt(votedSpan.text());

            // 取消赞动作
            if(isLiked){
                voteLoading = false;
                return;
                // 动画效果
                likedSpan.css('opacity', '0.99').animate({
                opacity: 0.1,
                }, 500, function(){

                likedSpan.removeClass('glyphicon-heart').addClass('glyphicon-heart-empty').css('opacity', '0.99');
                votedSpan.text(voteCount<=1 ? 0 : (voteCount - 1));
                });
            } 
            else {
                var url = '/question/like_answer';
                var postData = {'answer_id':btn.parents('li:eq(0)').attr('id').split('_')[1]};
                ajaxSend(url, postData, function(data){
                    voteLoading = false;
                    if(data['flag'] == '0')
                    {
                        // 添加赞动作
                        btn.parent('.btn-group-vertical').append('<span class="glyphicon glyphicon-heart animate-liked"></span>');
                        // 动画效果
                        var animateLike = btn.siblings();
                        animateLike.animate({
                          opacity: 0.01,
                          fontSize: 16,
                          paddingLeft: 10,
                          paddingTop: 6
                        }, 500, function(){
                          animateLike.remove();

                          likedSpan.removeClass('glyphicon-heart-empty').addClass('glyphicon-heart');
                          votedSpan.text(voteCount + 1);
                        });
                    }
                    else
                    {
                        alert(data['result']);
                    }
                });
            }
        });

        // 精华盖章动画
        var jinghua = $('.jinghua img');
        jinghua.show()
        .css({'width': '444.5px', 'height': '385px'})
        .animate({'width': '254', 'height': '220px', 'opacity': '0.6'}, 500)
        .animate({'width': '127px', 'height': '110px', 'opacity': '0.99'}, 50);

    });
</script>
{% endblock %}

{% block css %}
<style type="text/css">

.zx-container-main .question-entry{
    float: left;
    /*padding-top: 25px;*/
    width: 100%;
}

.zx-container-main .question-entry .topic{
    border-radius: 4px;
    padding: 15px;
    border: solid 1px #ddd;
}

.zx-container-main .question-entry .topic-content{
    padding-top: 25px;
    font-size: 13px;
}

.zx-container-main .question-entry .question-date{
    font-size: 12px;
}

.zx-container-main .replies{
    width: 100%;
    padding-top: 25px;
}

.zx-container-main .reply-header{
    padding: 15px 5px 5px 5px;
}


.zx-container-main .reply-header .user-name a{
    color: #333333;
    font-size: 12px;
}

.zx-container-main .reply-content{
    font-size: 13px;
    padding-top: 10px;
    padding-bottom: 15px;
    line-height: 25px;
}

.zx-container-main .reply-main .vote{
    padding-left: 30px;
    padding-top: 10px;
}

.zx-container-main .reply-main .vote .btn-group-vertical{
    width: 90%;
}


.answer-title{
  border-bottom: solid 1px #e6e6e6;
}

.answer-main{
  margin-top: 15px;
  border: solid 1px #e6e6e6;
  border-radius: 5px;
}

.answer-main .editor{
  margin-bottom: 0px;
}

.answer-main button{
  margin-top: 15px;
}

.not-login{
  font-size: 12px;
}

.not-login .title{
  font-size: 12px;
  padding: 25px 0 15px 0;
}

.not-login .content{
  font-size: 12px;
  padding-bottom: 15px;
  line-height: 22px;
}

.not-login .links{
  margin-bottom: 20px;
}

.not-login .lock{
  padding: 15px 0 0 30px;
}

.vote .glyphicon{
  font-size: 16px;
}

.vote .glyphicon-heart{
  color: red;
}

.vote .animate-liked{
  position: absolute;
  top: 0px;
  left: 2px;
  z-index: 99;
  font-size: 35px;
  opacity: 0.99,
}

.breadcrumb{
  margin-top: 25px;
  border: solid 1px #ddd;
}

.replies-sort{
  margin-top: 5px;
}

.my-reply{
  background-color: #f1f1f1;
}

.question-tool{
    font-size: 12px;
    /*float: right;*/
    padding-right: 10px;
}

.remove-reply{
    font-size: 12px;
    padding-top: 15px;
    width: 90%;
    text-align: center;
}

.question-content{
    border: solid 1px #ddd;
    border-radius: 4px;
}

.jinghua img{
  width: 127px;
  height: 110px;
  position: absolute;
  right: 40px;
  display: none;
  opacity: 0.1;
  top: 100px;
  z-index: 99;
}

.topic-tags ul.list-flow{
  padding: 10px 5px 10px 10px;
}

.topic-footer .avatar{
  width: 25px;
  height: 25px;
}

.answer-date{
  font-size: 12px;
}

.reply-tools{
  font-size: 12px;
  min-height: 16px;
}

.reply-comments{
  padding-top: 5px;
  display: none;
}

.reply-comments .arrow-in{
  width: 0px;
  height: 0px;
  border: 7px solid transparent;
  border-top: 0px;
  position: absolute;
  /*top: 0px;*/
  left: 40px;
  z-index: 101;
  padding-top: 1px;
  border-bottom-color: #ffffff;
}

.reply-comments .arrow-out{
  width: 0px;
  height: 0px;
  border: 7px solid transparent;
  border-top: 0px;
  position: absolute;
  /*top: 0px;*/
  left: 40px;
  border-bottom-color: #dddddd;
  z-index: 100;
}

.reply-comments>ul{
  padding-top: 7px;
}

.comment-left .avatar{
  width: 25px;
  height: 25px;
}

.comment-main{
  font-size: 12px;
  padding-left: 0px;
}

.comment-username{
  padding-bottom: 5px;
}

.comment-username a{
  color: #224e73;
}

.comment-username a:hover{
  color: #224e73;
}

.comment-content{
  padding-bottom:  5px;
}

.comment-date{
  color: #999999;
}

.comment-date .date{
  padding-right: 10px;
}

.send-comment{
  padding-left: 0px;
}
</style>
{% endblock %}

{% block question_main%}
<span class="jinghua">
  <img src="{{MEDIA_URL}}img/common/jinghua1.png"></span>

<ol class="breadcrumb">
  <li>
    <a href="/question">全部</a>
  </li>
  <li>
    <a href="{{question.question_type.get_url}}">{{question.question_type.name}}</a>
  </li>
  <li class="active">{{question.title|str_display:10}}</li>
</ol>
<div class="question-entry">
  <div class="topic">

    <div class="topic-title">
      <h4> <strong>{{question.title}}</strong>
      </h4>
    </div>
    <div class="topic-content">{{question.content|safe}}</div>
    <div class="topic-tags row">
      <ul class="list-flow">
        {% for tag in question_tags %}{% include "question/_tags.html" %}{% endfor %}
      </ul>
    </div>
    <div class="topic-footer row">
      <div class="col-md-6">
        {% if not question.is_hide_user %}
        <a href="{{question.user.get_url}}">
          <img class="avatar avatar-circle" src="{{question.user.get_avatar}}" title="{{question.user.nick}}" />
        </a>
        <a href="{{question.user.get_url}}" class="zx-cardtips" data-user_id="{{question.user.id}}">
          <div class="user-name">{{question.user.nick}}</div>
        </a>
        {% endif %}
      </div>
      <div class="col-md-6 text-right">
        {% if request.user.id == question.user.id %}
        <span class="question-tool">
          <a href="#" data-toggle="modal" data-target="#edit_modal">
            <span class="glyphicon glyphicon-pencil"></span>
            修改提问
          </a>
        </span>
        {% endif %}
        <span class="question-date">{{question.create_time}}</span>
      </div>
    </div>
    {% if request.user.id == question.user.id %}
    <!-- 弹出层 -->
    <div class="modal fade" id="edit_modal">
      <div class="modal-dialog">
        <div class="modal-content">
          <form role="form" method='post' action='/question/modify_question'>
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
              <h4 class="modal-title">修改提问</h4>
            </div>
            <div class="modal-body">

              <div class="form-group">
                <select name="question_type" class="form-control">
                  <option value='0'>请选择问题类型</option>
                  {% question_type_option_display %}
                </select>
              </div>
              <div class="blank10"></div>
              <div class="form-group">
                <input type="text" class="form-control" name="question_title" placeholder="你有什么想问的？写下问题的标题" 
                                    value='{{question.title}}'></div>
              <div class="form-group question-content">
                <textarea name="question_content" class="form-control zx-textarea auto-height-textarea" rows="10">{{question.content}}</textarea>
              </div>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
              <button type="submit" class="btn btn-primary">保存</button>
            </div>
          </form>
        </div>
        <!-- /.modal-content --> </div>
      <!-- /.modal-dialog --> </div>
    <!-- /.modal -->
    <!-- 弹出层结束 -->{% endif %}</div>

  <div class="replies">
    <ul class="list-group" id="ul_replies">
      <li class="list-group-item">
        <div class="row">
          <div class="col-md-6">
            <h4> <strong>共{{question.answer_count}}个回答</strong>
            </h4>
          </div>
          <!-- 
          <div class="col-md-3 pull-right">
            <select class="form-control input-sm replies-sort">
              <option>按赞最多排序</option>
              <option>按时间排序</option>
            </select>
          </div>
        -->
        </div>
      </li>
    {% for answer in answers %}
    <li class="list-group-item {% if answer.from_user_id == request.user.id %}my-reply{% endif %}" 
                id="answer_{{answer.id}}">
      <div class="reply-header row">
        <div class="col-md-6">
          <a href="{{answer.from_user.get_url}}">
            <img class="avatar avatar-circle" src="{{answer.from_user.get_avatar}}" title="{{answer.from_user.nick}}" />
          </a>
          <a href="{{answer.from_user.get_url}}" class="zx-cardtips" data-user_id="{{answer.from_user.id}}">
            <div class="user-name">{{answer.from_user.nick}}</div>
          </a>
        </div>
        <div class="col-md-6 text-right">
          <span class="answer-date">{{answer.create_time|time_format}}</span>
        </div>
      </div>
      <div class="reply-main row">
        <div class="reply-content col-md-9">{{answer.content|safe}}</div>
        <div class="vote col-md-3 text-right">
          <div class="btn-group-vertical">
            <button type="button" class="btn btn-default">
              <span class="glyphicon 
                                {% if answer.is_request_user_like %}glyphicon-heart{% else %}glyphicon-heart-empty{% endif %} 
                                pull-left"></span>
              <span class="badge">{{answer.like_count}}</span>
            </button>
          </div>
        </div>
      </div>
      <div class="reply-tools gray-a">
        <a class="comments hide" href="javascript: void(0);"><span class="glyphicon glyphicon-comment"></span> 88条评论</a>
        <a class="mark autohide hide" href="javascript: void(0);"><span class="glyphicon glyphicon-bookmark"></span> 收藏</a>
        <a class="share autohide hide" href="javascript: void(0);"><span class="glyphicon glyphicon-share-alt"></span> 分享</a>
        <a class="report-answer autohide hide" href="javascript: void(0);"><span class="glyphicon glyphicon-flag"></span> 举报</a>
        {% if question.user.id == request.user.id %}
        <a class="remove-answer autohide pull-right" href="javascript: void(0);"><span class="glyphicon glyphicon-trash"></span> 删除</a>
        {% endif %}
      </div>

      <!--
      <div class="reply-comments">
        <span class="arrow-out"></span>
        <span class="arrow-in"></span>
        <ul class="list-group">
          <li class="list-group-item">
            <div class="comment row">
              <div class="col-md-1 comment-left"><img class="avatar avatar-circle" src="/static/img/common/user3.jpg"></div>
              <div class="col-md-11 comment-main">
                <div class="comment-username"><a href="#" class="zx-cardtips" data-user_id="1">半夜没事瞎溜达</a></div>
                <div class="comment-content">看得我充满斗志, 热血沸腾</div>
                <div class="comment-date gray-a">
                  <span class="date">2014-02-16 12:25:56</span>
                  <a href="javascript: void(0);" class="thumbs-up"><span class="glyphicon glyphicon-thumbs-up"></span> 5赞</a>
                  <a href="javascript: void(0);" class="say-to autohide"><span class="glyphicon glyphicon-share"></span> 回复</a>
                  <a href="javascript: void(0);" class="report-comment autohide"><span class="glyphicon glyphicon-flag"></span> 举报</a>
                  <a class="remove-comment autohide pull-right" href="javascript: void(0);"><span class="glyphicon glyphicon-trash"></span> 删除</a>
                </div>
              </div>
            </div>
          </li>
          <li class="list-group-item">
            <div class="comment row">
              <div class="col-md-1 comment-left"><img class="avatar avatar-circle" src="/static/img/common/user1.jpg"></div>
              <div class="col-md-11 comment-main">
                <div class="comment-username"><a href="#" class="zx-cardtips" data-user_id="1">习大大</a></div>
                <div class="comment-content">我本科财务管理专业（自以为和会计专业无非名字不同学的都是难分彼此的东西），你若实心想从事会计行业，先去考会从吧（是会计工作的准入证书，就像你要给人看病你得先有个证明你是医生的东西），然后找份财务方面工作，将书本中的东西在现实工作中一一实践积累经验的同事下工夫考CPA之类的高级职称，之后便如这个答案说的干一个擅长的门类，越过越牛！</div>
                <div class="comment-date gray-a">
                  <span class="date">2014-02-16 12:28:06</span>
                  <a href="javascript: void(0);" class="thumbs-up"><span class="glyphicon glyphicon-thumbs-up"></span> 10赞</a>
                  <a href="javascript: void(0);" class="say-to autohide"><span class="glyphicon glyphicon-share"></span> 回复</a>
                  <a href="javascript: void(0);" class="report-comment autohide"><span class="glyphicon glyphicon-flag"></span> 举报</a>
                  <a class="remove-comment autohide pull-right" href="javascript: void(0);"><span class="glyphicon glyphicon-trash"></span> 删除</a>
                </div>
              </div>
            </div>
          </li>
          <li class="list-group-item">
            <div class="comment row">
              <div class="col-md-1 comment-left"><img class="avatar avatar-circle" src="/static/img/common/user2.jpg"></div>
              <div class="col-md-11 comment-main">
                <div class="comment-username"><a href="#" class="zx-cardtips" data-user_id="1">女王大人</a></div>
                <div class="comment-content">先考会计证，然后去考CPA，同时复习司法考试，争取几年内三证到手，苦练英语，届时潜力无穷。</div>
                <div class="comment-date gray-a">
                  <span class="date">2014-02-16 12:33:31</span>
                  <a href="javascript: void(0);" class="thumbs-up"><span class="glyphicon glyphicon-thumbs-up"></span> 赞</a>
                  <a href="javascript: void(0);" class="say-to autohide"><span class="glyphicon glyphicon-share"></span> 回复</a>
                  <a href="javascript: void(0);" class="report-comment autohide"><span class="glyphicon glyphicon-flag"></span> 举报</a>
                  <a class="remove-comment autohide pull-right" href="javascript: void(0);"><span class="glyphicon glyphicon-trash"></span> 删除</a>
                </div>
              </div>
            </div>
          </li>
          <li class="list-group-item">
            <div class="row">
              <div class="col-md-10"><input name="comment" class="form-control"></div>
              <div class="col-md-2 send-comment"><button type="button" class="btn btn-primary btn-block">评论</button></div>
            </div>
          </li>
        </ul>
      </div>
    -->
    </li>
    {% endfor %}
  </ul>
</div>

<!-- 回复块 -->
<div class="answer">
  <div class="answer-title">
    <h3>可以在下面添加你的回答</h3>
  </div>

  <div class="answer-main">
    {% if request.user.is_authenticated %}
    <form role="form" method="post" action="/question/create_answer/{{question.id}}">
      <div class="form-group editor">
        <textarea name="answer_content" class="form-control zx-textarea auto-height-textarea" rows="10">{{content}}</textarea>
      </div>
      <div class="form-group pull-right">
        <button type="submit" class="btn btn-primary">提交你的回答</button>
      </div>
    </form>
    {% else %}
    <div class="not-login row">
      <div class="col-md-2 lock">
        <img src="{{MEDIA_URL}}img/common/icon-locked.png"></div>
      <div class="col-md-10">
        <div class="title">回复前请登录</div>
        <div class="content">须登录后才能发表你的回复，点击下面的登录按钮进行登录，如果你还没有成为我们的会员，请点击下面的注册按钮进行新用户注册</div>
        <div class="col-md-6 links">
          <a href="/login">
            <button type="button" class="btn btn-primary btn-lg btn-login">立即登录</button>
          </a>
        </div>
        <div class="col-md-6 links">
          <a href="/regist">
            <button type="button" class="btn btn-primary btn-lg btn-regist">免费注册</button>
          </a>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
</div>
{% endblock %}