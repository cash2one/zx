{% extends "base/base_home.html" %}
{% load custom_tags %}
{% load custom_filters %}

{% block title %}首页{% endblock title %}
{% block home_css %}
<style type="text/css">
.hot-topics{
	border-top: 0;
}
</style>
{% endblock %}

{% block home_js %}
<script type="text/javascript">
$(document).ready(function(){

    var Feed = Backbone.Model.extend({
        defaults: {
            'feedId': '',           // 动态id 
            'feedDate': '',         // 动态时间
            'feedType': 0,          // 动态类型 (1提问 2赞回答 3回答)
            'userId': '',           // 用户id
            'userAvatar': '',       // 用户头像
            'userName': '',         // 用户名
            'questionId': 0,        // 提问id
            'questionTitle': '',    // 提问标题
            'questionDesc': '',     // 提问描述
            'questionViewCount': 0, // 提问浏览次数
            'questionAnswerCount':0,// 提问回答个数
            'answerId': 0,          // 回答id
            'answerContent': '',    // 回答内容
            'answerUserId': '',     // 回答者id
            'answerUserName': '',   // 回答者名字
            'answerUserAvatar': '', // 回答者头像
            'answerUserDesc': '',   // 回答者个人简介
            'answerLikeCount': 0    // 回答获赞个数
        }
    });
    var User = Backbone.Model.extend({
        defaults: {
            'userId': '',           // 用户id
            'userName': '',         // 用户名称
            'userAvatar': '',       // 用户头像
            'userGender': '',       // 用户性别
            'userDesc': '',         // 用户简介
            'likeCount': 0,         // 获赞个数
            'answerCount': 0,       // 回答个数
            'questionCount': 0      // 提问个数
        }


    });


    var Feeds = Backbone.Collection.extend({
        model: Feed,

        _modelMaps: {
            'feedId': 'feed_id',           
            'feedDate': 'create_time',         
            'feedType': 'feed_type',         
            'userId': 'user_id',           
            'userAvatar': 'user_avatar',       
            'userName': 'user_nick',         
            'questionId': 'question_id',       
            'questionTitle': 'question_title',   
            'questionDesc': 'question_summary',     
            'questionViewCount': 0, 
            'questionAnswerCount': 'question_answer_count',
            'answerId': 'answer_id',          
            'answerContent': 'answer_summary',    
            'answerUserId': 'answer_user_id',     
            'answerUserName': 'answer_user_nick',   
            'answerUserAvatar': 'answer_user_avatar', 
            'answerUserDesc': 'answer_user_des',   
            'answerLikeCount': 'answer_like_count'    
        },

        // 获得最后一个feedId
        getLastFeedId: function(){
            if(this.length > 0){
                return this.models[this.length - 1].get('feedId');
            }

            return null;
        },

        // 查询
        search: function(feedId){

            var me = this;

            g_ajax_processing_obj_id = 'loadingMoreFeed';
            ajaxSend("/timeline/get_user_timeline", {'last_feed_id': feedId}, function(data){
                if(data.feeds){
                    me.reset($.ZXUtils.dictMapParse(data.feeds, me._modelMaps));
                }

                // 需要推荐用户
                if(data.need_get_recommended_user){
                    recommendUsersView.collection.search(false);
                }
            });

            return this;
        }
    });
    var Users = Backbone.Collection.extend({
        model: User,

        _modelMaps: {
            'userId': 'user_id',           
            'userName': 'nick',         
            'userAvatar': 'avatar',       
            'userGender': 'gender',       
            'userDesc': 'des',
            'likeCount': 'user_liked_count',
            'answerCount': 'user_answer_count',
            'questionCount': 'user_question_count'
        },

        // 加载推荐用户
        search: function(random){
            var me = this;

            g_ajax_processing_obj_id = $('.recommend-users .refresh').setUUID().attr('id');
            ajaxSend("/account/get_recommend_users", {'random': random?'1':'0'}, function(data){
                if(data){
                    me.reset($.ZXUtils.dictMapParse(data, me._modelMaps));
                }
            });

            return this;
        }
    });

    var FeedView = Backbone.View.extend({
        el: '.feed-list',

        template: _.template($('#feed-template').html()),

        // 查看更多模板
        getMoreTemplate: _.template($('#getMore-template').html()),

        events: {
            'click .get-more': 'getMore'
        },

        initialize: function(){
            // 监听集合的reset事件
            this.listenTo(this.collection, 'reset', this.getFeed);

            // 首次查询
            this.collection.search();

        },

        render: function(data){
            this.$el.append(this.template({'feeds': data}));

            // 初始化名片
            $.ZXTooltipster.PersonCard();
        },

        renderGetMore: function(feedId){
            this.$el.append(this.getMoreTemplate({'feedId': feedId}));
        },

        // 根据最后一个feedId 获取之后的feed
        getFeed: function(){
            var data = this.collection.toJSON(),
                lastFeedId = this.collection.getLastFeedId();
            
            this.render(data);

            // 去掉上次的 查看更多 按钮
            this.$('.get-more').parents('li').remove();
            // 是否显示更多
            if(lastFeedId){
                this.renderGetMore(lastFeedId);
            }
        },

        // 查看更多
        getMore: function(){
            var feedId = this.$('.get-more').data('feed_id');
            
            // 隐藏原先的 查看更多 按钮
            this.$('.get-more').hide();

            this.collection.search(feedId);
        }

    });
    var RecommendUsersView = Backbone.View.extend({
        el: '.recommend-users',

        template: _.template($('#recommendUsers-template').html()),

        events: {
            'click .refresh': 'refreshUser',
            'click .follow': 'followUser',
            'click .unfollow': 'unfollowUser'
        },

        initialize: function(){
            // 监听集合的reset事件
            this.listenTo(this.collection, 'reset', this.getRecommendUsers);

            // 首次查询
            //this.collection.search(false)
        },

        render: function(data){
            this.$el.show();
            this.$('.list-inline').html(this.template({'users': data}));
        },

        // 获取推荐用户
        getRecommendUsers: function(){
            var data = this.collection.toJSON();

            this.render(data);
        },

        // 换一换
        refreshUser: function(){
            this.$('ul').fadeOut(300);
            this.collection.search(true)
            this.$('ul').fadeIn(300);
        },

        // 关注用户
        followUser: function(sender){
            var target = $(sender.currentTarget),
                userId = target.data('user_id');

            $.ZXOperation.followPeople(userId, function(){
                target.hide();
                target.next().show();
            });
        },

        // 取消关注
        unfollowUser: function(sender){
            var target = $(sender.currentTarget),
                userId = target.data('user_id');

            $.ZXOperation.unfollowPeople(userId, function(){
                target.hide();
                target.prev().show();
            });
        }
    });


    var feeds = new Feeds(),
        users = new Users(),
        feedView = new FeedView({'collection': feeds}),
        recommendUsersView = new RecommendUsersView({'collection': users});
});
</script>
{% endblock %}

{% block container_content %}
<div class="col-md-8">
	<div class="bottom-border bdc-bbb row pt-10 pb-5">
	    <div class="col-md-6">
	        <span class="f16 fb">最新动态</span>
	    </div>
	</div>

    <!-- 推荐关注 -->
    <div class="recommend-users pl-15 pr-15 pb-15 none">
        <div class="co8 f14 text-center pt-15 pb-15">
            首页内容太少，多关注些朋友吧
            <a href="javascript: void(0)" class="refresh f12 pl-10">
                <span class="glyphicon glyphicon-refresh"></span>换一换
            </a>
        </div>

        <ul class="list-inline row pl-15 pr-15 border-1 bdc-ddd border-radius-4 ">
        </ul>
    </div>

	<ul class="list-group feed-list">
    </ul>
	
</div>

<div class="col-md-4 pl-50">
	<!-- 推荐用户 -->
    {#% global_recommend_users %#}

    <!-- 热门话题 -->
    {% global_hot_topics %}

    <!-- 二维码 -->
    {% include 'include/_global_qrcode.html' %}

    <!-- 统计 -->
    {% global_statistic %}
    
</div>


<!-- 推荐用户模板 -->
<script type="text/template" id="recommendUsers-template">
    <% _.each(users, function(user){ %>
        <li class="col-md-6 col-xs-12 bottom-border bdc-eee pt-15 pb-10">
            <a href="/p/<%= user.userId %>"><img class="pa avatar-45 avatar-circle" alt="<%= user.userName %>" src="<%= user.userAvatar %>"></a>
            <div class="pl-55 pr-10">
                <div>
                    <a href="/p/<%= user.userId %>" class="">
                        <%= user.userName %>
                        <% if (user.userGender == 1) { %>
                            <img class="w15 mt--2" src="{{MEDIA_URL}}img/common/male.png" alt="男" title="男" />
                        <% } %>
                        <% if (user.userGender == 2) { %>
                            <img class="w15 mt--2" src="{{MEDIA_URL}}img/common/female.png" alt="女" title="女" />
                        <% } %>
                    </a>
                    <button class="btn btn-xs btn-primary pull-right follow" data-user_id='<%= user.userId %>'>添加关注</button>
                    <button class="btn btn-xs btn-default pull-right unfollow none" data-user_id='<%= user.userId %>'>取消关注</button>
                </div>
                <div class="pt-5">
                    <span>提问 <a href="/p/<%= user.userId %>/questions"><%= user.questionCount %></a></span>
                    <span class="pl-15">回答 <a href="/p/<%= user.userId %>/answers"><%= user.answerCount %></a></span>
                    <span class="pl-15">赞 <a href="javascript: void(0);"><%= user.likeCount %></a></span>
                </div>
                <div class="f12 co8 pt-5"><%= user.userDesc %></div>
            </div>
        </li>
    <% }) %>
</script>

<!-- feed 模板 -->
<script type="text/template" id="feed-template">
    <% _.each(feeds, function(feed){ %>

        <% if(feed.feedType == 1){ %>
        <li class="list-group-item no-l-r-bd bdc-eee pl-0">
            <a href="/p/<%= feed.userId %>"><img class="pa avatar-45 avatar-circle" alt="<%= feed.userName %>" src="<%= feed.userAvatar %>"></a>
            <div class="pl-55">
                <div class="co8 f12">
                    <a href="/p/<%= feed.userId %>" class="zx-cardtips" data-user_id='<%= feed.userId %>'><%= feed.userName %></a> 提出了该问题
                </div>
                <div class="pt-5">
                    <a class="black-blue f16 fb" href="/question/<%= feed.questionId %>"><%= feed.questionTitle %></a>
                </div>
                <div class="pt-10 f13"><%= feed.questionDesc %></div>
                <div class="f12 co8 gray-a pt-5">
                    <span><%= feed.questionAnswerCount %> 个回答 • <%= feed.feedDate %></span>
                </div>
            </div>
        </li>
        <% } %>

        <% if(feed.feedType == 2){ %>
        <li class="list-group-item no-l-r-bd bdc-eee pl-0">
            <a href="/p/<%= feed.userId %>"><img class="pa avatar-45 avatar-circle" alt="<%= feed.userName %>" src="<%= feed.userAvatar %>"></a>
            <div class="pl-55">
                <div class="co8 f12">
                    <a href="/p/<%= feed.userId %>" class="zx-cardtips" data-user_id='<%= feed.userId %>'><%= feed.userName %></a> 赞了该回答
                </div>
                <div class="pt-5">
                    <a class="black-blue f16 fb" href="/question/<%= feed.questionId %>"><%= feed.questionTitle %></a>
                </div>
                <div class="pt-10 f12">
                    <a href="/p/<%= feed.answerUserId %>" class="zx-cardtips pr-5 black-blue fb" data-user_id='<%= feed.answerUserId %>'><%= feed.answerUserName %></a><% if(feed.answerUserDesc) {%><span class="fb">(<%= feed.answerUserDesc %>)</span><% } %>
                </div>
                <div class="pt-5 f13">
                    <%= feed.answerContent %>
                    <a href="question/<%= feed.questionId %>#to_answer_<%= feed.answerId %>" class="pl-5 f12">
                        <span class="f12 glyphicon glyphicon-send pr-3"></span>查看详细
                    </a>
                </div>
                <div class="f12 co8 gray-a pt-5">
                    <span><%= feed.answerLikeCount %> 个赞 • <%= feed.feedDate %></span>
                </div>
            </div>
        </li>
        <% } %>

        <% if(feed.feedType == 3){ %>
        <li class="list-group-item no-l-r-bd bdc-eee pl-0">
            <a href="/p/<%= feed.userId %>"><img class="pa avatar-45 avatar-circle" alt="<%= feed.userName %>" src="<%= feed.userAvatar %>"></a>
            <div class="pl-55">
                <div class="co8 f12">
                    <a href="/p/<%= feed.userId %>" class="zx-cardtips" data-user_id='<%= feed.userId %>'><%= feed.userName %></a> 回答了该提问
                </div>
                <div class="pt-5">
                    <a class="black-blue f16 fb" href="/question/<%= feed.questionId %>"><%= feed.questionTitle %></a>
                </div>
                <div class="pt-10 f13">
                    <%= feed.answerContent %>
                    <a href="question/<%= feed.questionId %>#to_answer_<%= feed.answerId %>" class="pl-5 f12">
                        <span class="f12 glyphicon glyphicon-send pr-3"></span>查看详细
                    </a>
                </div>
                <div class="f12 co8 gray-a pt-5">
                    <span><%= feed.answerLikeCount %> 个赞 • <%= feed.feedDate %></span>
                </div>
            </div>
        </li>
        <% } %>
    <% }) %>
</script>

<!-- 更多按钮模板 -->
<script type="text/template" id="getMore-template">
    <li class="list-group-item no-l-r-bd bdc-eee pl-0 no-border">
        <div class="text-center">
            <span id="loadingMoreFeed"></span>
            <button type="button" class="btn btn-block btn-default get-more" data-feed_id="<%= feedId %>">查看更多...</button>
        </div>
    </li>
</script>
{% endblock container_content %}