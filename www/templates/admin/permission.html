{% extends "admin/home.html" %}
{% load custom_tags %}
{% load custom_filters %}
{% block title %}推荐用户管理{% endblock %}

{% block css %}
<style type="text/css">

</style>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
$(document).ready(function(){
    var Administrator = Backbone.Model.extend({
        defaults: {
            'num': '',
            'userId': '',
            'userNick': '',
            'userAvatar': ''
        }
    });
    var UserPermission = Backbone.Model.extend({
        defaults: {
            'permissions': ''
        }
    });
    

    var Administrators = Backbone.Collection.extend({
        model: Administrator,

        _modelMaps: {
            'num': 'num',
            'userId': 'user_id',
            'userNick': 'user_nick',
            'userAvatar': 'user_avatar',
        },

        search: function(){
            var me = this;

            ajaxSend(
                "/admin/permission/get_all_administrators", 
                {}, 
                function(data){
                    me.reset($.ZXUtils.dictMapParse(data, me._modelMaps));
                }
            );
        }
        
    });
    var UserPermissions = Backbone.Collection.extend({
        model: UserPermission,

        search: function(userId, callback){
            var me = this;

            ajaxSend(
                "/admin/permission/get_user_permissions", 
                {'user_id': userId}, 
                function(data){
                    //me.reset($.ZXUtils.dictMapParse(data.permissions, me._modelMaps))
                    if(callback){
                        callback(data);
                    }
                }
            );
        },

        saveUserPermission: function(userId, permissions, callback){
            var me = this;

            ajaxSend(
                "/admin/permission/save_user_permission?" + permissions, 
                {'user_id': userId}, 
                function(data){
                    //me.reset($.ZXUtils.dictMapParse(data.permissions, me._modelMaps))
                    if(callback){
                        callback(data);
                    }
                }
            );
        }
        
    });

    var AdministratorView = Backbone.View.extend({
        el: '#administrator_list',

        template: _.template($('#administrator-template').html()),

        events: {
        },

        initialize: function(){
            this.listenTo(this.collection, 'reset', this.render);
        },

        events: {
            'click .pointer': 'modifyUserPermission'
        },

        render: function(){
            var data = this.collection.toJSON();
            
            this.showPanel();
            this.$('tbody').html(this.template({'administrators': data}));
            
        },

        // 显示面板
        showPanel: function(){
            $('.zx-nav-pills a[href="#administrator_list"]').tab('show');
        },

        // 修改用户权限
        modifyUserPermission: function(sender){
            var target = $(sender.currentTarget),
                userId = target.data('user_id');

            modifyUserPermissionView.modifyUserPermission(userId);
        }

    });
    var ModifyUserPermissionView = Backbone.View.extend({
        el: '#modify_user_permission',

        initialize: function(){
            this.listenTo(this.collection, 'reset', this.render);
        },

        events: {
            'click .parent-checkbox': 'parentCheck',
            'click .child-checkbox': 'childCheck',
            'click .save-user-permission': 'saveUserPermission',
            'click .cancel-admin': 'cancelAdmin'
        },

        render: function(data, user){
            var me = this;

            me.$('.user-name').html(user.user_nick);
            me.$('.user-name').data('user_id', user.user_id);

            me.$('input[type=checkbox]').attr('checked', false);

            _.map(data, function(p){
                me.$('#p_' + p).click();
            });
        },

        // 显示面板
        showPanel: function(){
            $('.zx-nav-pills a[href="#modify_user_permission"]').tab('show');
        },

        // 父选项选中事件
        parentCheck: function(sender){
            
            var target = $(sender.currentTarget);
            
            target
            .parent()
            .next()
            .find('.child-checkbox')
            .attr('checked', target.attr('checked') ? true : false);
                  
        },

        // 子选项选中事件
        childCheck: function(sender){
            var target = $(sender.currentTarget),
                flag = '';
            
            $.map(target.parents('.col-sm-10').find('.child-checkbox'), function(c){
                flag += c.checked ? '1' : '0';
            });
            
            // 父选项是否选中控制
            target
            .parents('.form-group')
            .find('.parent-checkbox')
            .attr('checked', (flag.indexOf('0') == -1) ? true : false);
            
        },


        modifyUserPermission: function(userId){
            var me = this;

            this.collection.search(userId, function(data){
                
                if(data.permissions.length > 0){
                    me.showPanel();
                    me.render(data.permissions, data.user);
                } else {
                    $.ZXMsg.alert('提示', '没有此用户!');
                }
            });
        },

        saveUserPermission: function(sender){
            var userId = this.$('.user-name').data('user_id'),
                me = this;
            
            this.collection.saveUserPermission(userId, this.$('form').serialize(), function(data){
                if(data.errcode === 0){
                    me.modifyUserPermission(userId);
                    $.ZXMsg.alert('提示', '修改成功!');
                } else {
                    $.ZXMsg.alert('提示', data.errmsg);
                }
                
            });
        },

        cancelAdmin: function(sender){
            var userId = this.$('.user-name').data('user_id');
            console.log(userId);
        }

    });

    var Router = Backbone.Router.extend({
        routes: {
            "":                                     "search",
            "searchUser/(:userNick)/:pageIndex":    "searchUser"
        },

        // 获取推荐用户
        search: function(){
            administrators.search();
        }
        
    });

    var administrators = new Administrators(),
        userPermissions = new UserPermissions(),
        administratorView = new AdministratorView({'collection': administrators}),
        modifyUserPermissionView = new ModifyUserPermissionView({'collection': userPermissions}),
        router = new Router();

    Backbone.history.start();
});

</script>
{% endblock %}

{% block admin-right %}
<ul class="nav nav-pills pt-15 zx-nav-pills">
    <li class="active">
        <a href="#administrator_list" class="black-blue" data-toggle="pill">管理员列表</a>
    </li>
    <li>
        <a href="#modify_user_permission" class="black-blue" data-toggle="pill">修改管理员权限</a>
    </li>
</ul>

<div class="tab-content">
    <!-- 管理员列表 -->
    <div class="tab-pane fade pt-15 in active" id="administrator_list">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>#</th>
                    <th>头像</th>
                    <th>用户名称</th>
                </tr>
            </thead>
            <tbody>
                
            </tbody>
        </table>
    </div>

    <!-- 修改管理员权限 -->
    <div class="tab-pane fade pt-15" id="modify_user_permission">
        <form class="form-horizontal" role="form" method="post" action="">
            <div class="form-group pt-20 pb-20 mb-0 bottom-border bdc-eee">
                <p>修改用户<span class="pl-15 pr-15 fb fi user-name" data-user_id=""></span>的管理权限</p>
            </div>
            {% for parent in permissions %}
            <div class="form-group pt-20 pb-20 mb-0 bottom-border bdc-eee">
                <label class="col-sm-2 control-label pointer">
                    <input class="parent-checkbox" type="checkbox" id="p_{{ parent.code }}" value="{{ parent.code }}"> {{ parent.name }}
                </label>
                <div class="col-sm-10">
                    {% for child in parent.children.all %}
                    <label class="checkbox-inline pl-40">
                        <input class="child-checkbox" type="checkbox" id="p_{{ child.code }}" name="permissions" value="{{ child.id }}"> {{ child.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            <div class="form-group pt-20 pb-20 mb-0 bottom-border bdc-eee">
                <div class="col-md-12">
                    <button type="button" class="btn btn-primary save-user-permission">提交你的修改</button>
                    <button type="button" class="btn btn-danger ml-15 cancel-admin">取消此管理员</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script type="text/template" id="administrator-template">
<% _.each(administrators, function(administrator){ %>
    <tr class="pointer" data-user_id="<%= administrator.userId %>">
        <td><%= administrator.num %></td>
        <td><img src="<%= administrator.userAvatar %>" class="avatar-35 avatar-circle" ></td>
        <td><%= administrator.userNick %></td>
    </tr>
<% }) %>
</script>

<script type="text/template" id="modify-user-permission-template">

</script>
{% endblock admin-right %}